---
- name: "PLAY 1"
  hosts: VA006
  gather_facts: false
  connection: network_cli

  tasks:
    - name: "RUN COMMAND AND PARSE WITH TEXTFSM"
      ansible.utils.cli_parse:
        command: show cdp neighbors detail
        parser:
          name: ansible.utils.textfsm
          template_path: "/home/ttweed98/CDP-Test/ntc-templates/ntc_templates/templates/cisco_ios_show_cdp_neighbors_detail.textfsm"
        set_fact: neighbor_data
      

    - name: "LIST ATTACHED CISCO DEVICES"
      set_fact:
        Destination: "{{ neighbor_data | selectattr('SOFTWARE_VERSION', 'contains' , 'Cisco') }}"

    - name: "CREATE LIST OF HOSTS"
      set_fact:
        devices: "{{ Destination | map(attribute='DESTINATION_HOST') | unique }}"

    - name: "SHOW VLANS ON CORE SWITCH"
      cisco.ios.ios_command:
        commands: "show vlan brief | include 1870"
      register: vlan_output

    - name: "CREATE MGMT VLAN VARIABLE"
      set_fact:
        vlan_1870: "{{ vlan_output['stdout'] | first}}"
 
    - name: "CREATE VLANS ON CORE SWITCH"
      cisco.ios.ios_config:
        src: vlans.j2

    - name: "CREATE LIST OF LOCAL INTERFACE PORTS TO FILE"
      template: src=local_port.j2 dest=/home/ttweed98/CDP-Test/files/core_intf.yml

    - name: "MAKE LOCAL INTERFACES AVAILABLE AS VARIABLE"
      ansible.builtin.include_vars:
        file: /home/ttweed98/CDP-Test/files/core_intf.yml

    - name: "SHOW VLANS ON CORE SWITCH TRUNKS"
      cisco.ios.ios_command:
        commands: 
          - "show run interface {{ item }} | include switchport trunk allowed"
      register: interface_output
      loop: "{{ core_intf }}"

    - name: "Creating VLANS ON CORE INTERFACES"
      include_tasks: create_intf_vlans.yml
      when: item.stdout[0] != "" 
      loop: "{{ interface_output['results'] }}"
    
    - name: "CREATING DYNAMIC REMOTE HOSTS FILE WITH JINJA"
      template: src=testcdp.j2 dest=/home/ttweed98/CDP-Test/files/remote_hosts.yml

    - name: "MAKE REMOTE HOSTS FILE AVAILABLE"
      ansible.builtin.include_vars:
        file: /home/ttweed98/CDP-Test/files/remote_hosts.yml

    - name: "ADD ALL REMOTE HOSTS TO VA006 GROUP"
      ansible.builtin.add_host:
        hostname: "{{ item['hostname'] }}"
        ansible_host: "{{ item['host_ip'] }}"
        groups: VA006
        interfaces: "{{ item['remote_port'] }}"
      loop: "{{ remote_hosts }}"

    - name: "CREATE VLANS ON REMOTE HOSTS"
      include_tasks: "vlan_tasks.yml"
      loop: "{{ remote_hosts }}"

    - name: "CREATE LIST OF REMOTE INTERFACE PORTS TO FILE"
      template: src=remote_port.j2 dest=/home/ttweed98/CDP-Test/files/remote_intf.yml

    - name: "MAKE REMOTE INTERFACES AVAILABLE"
      ansible.builtin.include_vars:
        file: /home/ttweed98/CDP-Test/files/remote_intf.yml

    - name: "SHOW VLANS ON REMOTE SWITCH TRUNKS"
      include_tasks: show_vlans_remote.yml
      loop: "{{ remote_hosts }}"
      

    # - name: "Creating VLANS ON REMOTE INTERFACES"
    #   include_tasks: create_remote_intf_vlans.yml
    #   when: item.stdout[0] != "" 
    #   loop: "{{ interface_output['results'] }}"
      

# - name: " CREATE VLANS ON REMOTE HOSTS"
#   hosts: all
#   gather_facts: false
#   connection: network_cli 

  # tasks:
    # - name: "ADD VLANS TO REMOTE HOSTS"
    #   cisco.ios.ios_config:
    #     src: vlans.j2

    # - name: "MAKE LOCAL INTERFACES AVAILABLE"
    #   ansible.builtin.include_vars:
    #     file: /home/ttweed98/CDP-Test/files/remote-intf.txt

    # - name: "CREATE VLANS ON LOCAL INTERFACES"
    #   cisco.ios.ios_config:
    #     src: core-int-vlans.j2
    # - name: "CREATE VLANS ON REMOTE HOSTS"
    #   cisco.ios.ios_config:
    #     src: vlans.j2
    #   loop: "{{ remote_hosts }}"

    # - name: Add all hosts running this playbook to the done group
    #   ansible.builtin.add_host:
    #     hostname: "{{ item['hostname'] }}"
    #     ansible_host: "{{ item['host_ip'] }}"
    #     groups: VA006
    #     interfaces: "{{ item['remote_port'] }}"
    #   loop: "{{ remote_hosts }}"

    # - name: "CREATE VLANS ON CORE SWITCH"
    #   cisco.ios.ios_config:
    #     src: vlans.j2         

    # - name: "CREATE VLANS ON CORE INTERFACES"
    #   cisco.ios.ios_config:
    #     src: vlans.j2          

    # - name: Print
    #   debug: 
    #     msg: "{{ Destination }}"

    # - name: Print hosts
    #   debug:
    #     msg: "{{ devices }}"
    # - name: "Create hosts with CDP Neighbors"
    #   template: src=hosts.j2 dest=/home/ttweed98/CDP-Test/hosts

    # - name: "Create interface list with conencted devices using CDP Neighbors"
    #   ansible.builtin.include_vars:
    #     file: /home/ttweed98/CDP-Test/host-vars/CORE.txt

    # - name: "Create interface list with conencted devices using CDP Neighbors"
    #   template: src=local_int-vlans.j2 dest=/home/ttweed98/CDP-Test/host-vars/CORE1.txt

    # - name: "Add DMZ VLANS as variables"
    #   ansible.builtin.include_vars:
    #     file: /home/ttweed98/CDP-Test/files/vlans.txt

    # - name: "Make interface variables available"
    #   ansible.builtin.include_vars:
    #     file: /home/ttweed98/CDP-Test/host-vars/CORE1.txt

    # - name: "Create vlans"
    #   template: src=host-vlans.j2 dest=/home/ttweed98/CDP-Test/core-vlans.txt
#     - name: "Add Vlans to trunks on Core switch"
#       cisco.ios.ios_config:
#         src: core-vlans.j2

# - name: Test connection to remote hosts"
#   hosts: VA006
#   gather_facts: false
#   connection: network_cli

#   tasks:
#     - name: "Add DMZ VLANS as variables"
#       ansible.builtin.include_vars:
#         file: /home/ttweed98/CDP-Test/files/vlans.txt

#     - name: "Make interface variables available"
#       ansible.builtin.include_vars:
#         file: /home/ttweed98/CDP-Test/host-vars/CORE1.txt

#     - name: "Create vlans"
#       cisco.ios.ios_config:
#         src: host-vlans.j2

#     - name: "Add Vlans to trunks on Remote switches"
#       cisco.ios.ios_config:
#         lines:
#           - "switchport trunk allowed vlan add 1870,1875,1880,1890"
#         parents: "{{ item }}"
#       with_items:
#         - interface port-channel1
#     - name: "Add Vlans to trunks on Core switch"
#       template: src=core-vlans.j2 dest=dest=/home/ttweed98/CDP-Test/core-vlans.txt
# - name: "PLAY 2"
#   hosts: CORE
#   gather_facts: false
#   connection: network_cli

#   tasks:
#     - name: "Add vlans test"
#       template: src=vlans.j2 dest=/home/ttweed98/CDP-Test/vlans.txt

#     - name: "Print output"
#       debug:
#         msg: "{{ vlan_output }}"
# - name: Remove file (delete file)
#   ansible.builtin.shell:
#     chdir: /home/svc_nwautomation/Tony-Test/inventory
#     cmd: rm -rf *.yml

# - name: "CREATE FILE"
#   lineinfile:
#     path: inventory/{{ item }}.yml
#     line: "---"
#     state: present
#     create: true
#   loop: "{{ devices }}"

# - name:

# - name: Make sure group wheel is not in the sudoers configuration
#   set_fact:
#     Remote_Host: "{{ item }}"
#     Mgt_IP: "{{ Destination | selectattr('DESTINATION_HOST', 'equalto' , item) | map(attribute='MANAGEMENT_IP') }}"
#     Remote_Port: "{{ Destination | selectattr('DESTINATION_HOST', 'equalto' , item) | map(attribute='REMOTE_PORT') | list }}"
#   loop: "{{ devices }}"

# - name: Make sure group wheel is not in the sudoers configuration
#   ansible.builtin.blockinfile:
#     path: inventory/{{ item }}.yml
#     create: true
#     block: |
#           Remote_Host: "{{ item }}"
#           Mgt_IP: "{{ Destination | selectattr('DESTINATION_HOST', 'equalto' , item) | map(attribute='MANAGEMENT_IP') }}"
#           Remote_Port: "{{ Destination | selectattr('DESTINATION_HOST', 'equalto' , item) | map(attribute='REMOTE_PORT') | list }}"
#     marker: "# {mark} ANSIBLE MANAGED BLOCK {{ item }}"
#   loop: "{{ devices }}"

# - name: "REMOVE UNWANTED LINE"
#   lineinfile:
#     path: inventory/{{ item }}.yml
#     regexp: "^#.*"
#     state: absent
#   loop: "{{ devices }}"

# - name: Create Local Port connections to remote devices
#   ansible.builtin.blockinfile:
#     path: /home/svc_nwautomation/Tony-Test/group_vars/VA006.yml
#     create: true
#     block: |
#           Local_Port: "{{ Destination | selectattr('DESTINATION_HOST', 'equalto' , item) | map(attribute='LOCAL_PORT') }}"
#     marker: "# {mark} ANSIBLE MANAGED BLOCK {{ item }}"
#   loop: "{{ devices }}"

# - name: "REMOVE UNWANTED LINE in Group Var"
#   lineinfile:
#     path: /home/svc_nwautomation/Tony-Test/group_vars/VA006.yml
#     regexp: "^#.*"
#     state: absent
#   loop: "{{ devices }}"
